
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ChocoCost V1.10</title>
  
  <!-- 1. STYLE (Tailwind) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ios: {
              bg: '#f2f2f7', card: '#ffffff', text: '#000000', subtext: '#8e8e93',
              blue: '#007aff', red: '#ff3b30', gold: '#d4af37', cocoa: '#3e2723',
            }
          },
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <!-- 2. MOTEUR (Babel + React) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
  </script>

  <style>
    body { -webkit-tap-highlight-color: transparent; user-select: none; -webkit-touch-callout: none; }
    .pt-safe { padding-top: env(safe-area-inset-top); }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* Animation fluide pour les modals */
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    
    /* Animation fade in */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }

    /* Animation Scale pour l'alerte */
    @keyframes scaleIn { from { transform: scale(1.1); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .animate-scale-in { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
  </style>
</head>
<body class="bg-ios-bg text-black h-screen overflow-hidden selection:bg-ios-blue selection:text-white">
  
  <div id="root" class="h-full"></div>

  <!-- 3. APPLICATION (Code complet intégré) -->
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      LayoutDashboard, ChefHat, Settings, Plus, Trash2, Download, Upload, 
      ChevronRight, List, X, Search, ChevronLeft, Filter, Camera, Image as ImageIcon, AlertTriangle, Link as LinkIcon
    } from 'lucide-react';

    // --- VERSION ---
    const APP_VERSION = "V1.10";

    // --- DATA & UTILITAIRES ---
    const generateId = () => Math.random().toString(36).substr(2, 9);
    
    const formatCurrency = (amount) => 
      new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(isNaN(amount) ? 0 : amount);

    const DEFAULT_SETTINGS = { 
      hourlyRate: 15.00, 
      defaultMargin: 40, 
      electricityCost: 0, 
      wastePercentage: 5, 
      chefName: 'Chef Audrey' 
    };
    
    const DEFAULT_CATEGORIES = ['Chocolat', 'Sous-recette', 'Fruits Secs', 'Sucre', 'Crèmerie', 'Arômes', 'Confiserie', 'Pâte à tartiner'];
    const PREDEFINED_ALLERGENS = ['Gluten', 'Lait', 'Œufs', 'Fruits à coque', 'Arachides', 'Soja', 'Sésame', 'Sulfites'];

    // Fonction de redimensionnement d'image (Max 800px)
    const resizeImage = (file, maxWidth = 800) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const elem = document.createElement('canvas');
                    const scaleFactor = maxWidth / img.width;
                    const width = maxWidth;
                    const height = img.height * scaleFactor;
                    
                    elem.width = width;
                    elem.height = height;
                    const ctx = elem.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compression JPEG 0.8
                    resolve(elem.toDataURL('image/jpeg', 0.8));
                };
                img.onerror = error => reject(error);
            };
            reader.onerror = error => reject(error);
        });
    };

    // --- LOGIQUE DE CALCUL ---
    const calculateRecipeMetrics = (recipeId, allRecipes, allIngredients, settings, depth = 0) => {
      if (depth > 10) return { totalCost: 0, materialCost: 0, laborCost: 0, wasteCost: 0, totalWeight: 0, costPerKg: 0 }; 
      
      const recipe = allRecipes.find(r => r.id === recipeId);
      if (!recipe) return { totalCost: 0, materialCost: 0, laborCost: 0, wasteCost: 0, totalWeight: 0, costPerKg: 0 };

      let totalMatCost = 0;
      let totalWeight = 0;

      if (recipe.ingredients) {
        recipe.ingredients.forEach(item => {
          if (item.recipeId) {
            totalWeight += item.quantity;
            const subMetrics = calculateRecipeMetrics(item.recipeId, allRecipes, allIngredients, settings, depth + 1);
            const subCostPerGram = subMetrics.totalWeight > 0 ? (subMetrics.totalCost / subMetrics.totalWeight) : 0;
            totalMatCost += item.quantity * subCostPerGram;

          } else if (item.ingredientId) {
            const ing = allIngredients.find(i => i.id === item.ingredientId);
            if (ing) {
              if (ing.unit === 'pce') {
                totalMatCost += item.quantity * ing.price;
                if (ing.weightPerUnit) {
                   totalWeight += item.quantity * ing.weightPerUnit;
                }
              } else {
                totalWeight += item.quantity; 
                totalMatCost += (item.quantity / 1000) * ing.price;
              }
            }
          }
        });
      }

      const laborCost = (recipe.prepTimeMinutes / 60) * settings.hourlyRate;
      const wasteCost = totalMatCost * (settings.wastePercentage / 100);
      const productionCost = totalMatCost + laborCost + wasteCost;
      
      return { 
        costPerKg: totalWeight > 0 ? (productionCost / (totalWeight / 1000)) : 0, 
        totalWeight, 
        materialCost: totalMatCost, 
        laborCost, 
        wasteCost, 
        totalCost: productionCost 
      };
    };

    // --- COMPOSANTS UI (IOS STYLE) ---

    // 1. Custom Alert Modal (Remplacement de window.confirm)
    const IOSAlert = ({ isOpen, title, message, onConfirm, onCancel }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm animate-fade-in" style={{zIndex: 9999}}>
          <div className="bg-white/90 backdrop-blur-xl w-[270px] rounded-2xl text-center shadow-xl transform transition-all animate-scale-in">
            <div className="p-5">
              <h3 className="font-bold text-[17px] mb-1 text-black">{title}</h3>
              <p className="text-[13px] text-black leading-snug">{message}</p>
            </div>
            <div className="flex border-t border-gray-300/50 text-[17px]">
              <button 
                onClick={onCancel} 
                className="flex-1 py-3 text-[#007aff] font-normal border-r border-gray-300/50 active:bg-gray-200/50 rounded-bl-2xl outline-none"
              >
                Annuler
              </button>
              <button 
                onClick={onConfirm} 
                className="flex-1 py-3 text-[#ff3b30] font-bold active:bg-gray-200/50 rounded-br-2xl outline-none"
              >
                Confirmer
              </button>
            </div>
          </div>
        </div>
      );
    };
    
    const IOSHeader = ({ title, rightAction, subtitle, leftAction, transparent = false }) => (
      <div className={`sticky top-0 z-20 pt-safe px-4 pb-2 transition-all ${transparent ? 'bg-transparent' : 'bg-ios-bg/90 backdrop-blur-xl border-b border-gray-300/50'}`}>
        <div className="flex justify-between items-center h-11">
           <div className="min-w-[40px] flex items-center">{leftAction || <div className="w-8"></div>}</div>
           {rightAction ? rightAction : <div className="w-8"></div>}
        </div>
        {!transparent && (
            <div className="mt-1 pb-2">
                <h1 className="text-[34px] font-bold tracking-tight text-black leading-tight">{title}</h1>
                {subtitle && <div className="text-ios-subtext font-medium text-sm mt-0.5">{subtitle}</div>}
            </div>
        )}
      </div>
    );

    const IOSListGroup = ({ children, title }) => (
      <div className="mb-6">
        {title && <div className="px-4 py-2 text-[13px] uppercase text-ios-subtext font-semibold">{title}</div>}
        <div className="bg-white rounded-xl overflow-hidden shadow-sm mx-4">
           {children}
        </div>
      </div>
    );

    const SwipeRow = ({ children, onDelete, enabled = true }) => {
      const [translateX, setTranslateX] = useState(0);
      const startX = useRef(null);
      
      const handleTouchStart = (e) => {
        if (!enabled) return;
        startX.current = e.touches[0].clientX;
      };

      const handleTouchMove = (e) => {
        if (!enabled || startX.current === null) return;
        const currentX = e.touches[0].clientX;
        const diff = currentX - startX.current;
        
        if (diff < 0) {
           setTranslateX(Math.max(diff, -100));
        } else if (translateX < 0) {
           setTranslateX(Math.min(diff - 80, 0));
        }
      };

      const handleTouchEnd = () => {
        if (!enabled) return;
        if (translateX < -40) {
          setTranslateX(-80);
        } else {
          setTranslateX(0);
        }
        startX.current = null;
      };

      const handleContentClick = (e) => {
         if (translateX < 0) {
            e.stopPropagation();
            setTranslateX(0);
         }
      };

      return (
         <div className="grid grid-cols-1 overflow-hidden border-b border-gray-100 last:border-0 select-none">
             {/* Arrière-plan (Bouton Supprimer) */}
             <div className="row-start-1 col-start-1 bg-ios-red flex items-center justify-end pr-6">
                 <button 
                    type="button"
                    className="flex items-center justify-center text-white outline-none"
                    onClick={(e) => { 
                       e.stopPropagation(); 
                       if(onDelete) onDelete(); 
                       setTranslateX(0); 
                    }}
                 >
                    <Trash2 size={24} />
                 </button>
             </div>
             
             {/* Premier plan (Contenu) */}
             <div 
                className="row-start-1 col-start-1 bg-white z-10 transition-transform duration-200 ease-out"
                style={{ transform: `translateX(${translateX}px)` }}
                onTouchStart={handleTouchStart}
                onTouchMove={handleTouchMove}
                onTouchEnd={handleTouchEnd}
                onClickCapture={handleContentClick}
             >
                {children}
             </div>
         </div>
      );
    };

    const IOSListItem = ({ children, onClick, icon: Icon, label, value, isLast = false, destructive = false }) => (
      <div onClick={onClick} className={`pl-4 pr-4 py-3 flex items-center justify-between active:bg-gray-100 transition-colors cursor-pointer relative ${!isLast ? 'border-b border-gray-100' : ''}`}>
         <div className="flex items-center gap-3 overflow-hidden w-full">
            {Icon && <div className="text-ios-blue"><Icon size={22} /></div>}
            <div className={`text-[17px] truncate w-full ${destructive ? 'text-ios-red' : 'text-black'}`}>{label || children}</div>
         </div>
         {(value || onClick) && (
             <div className="flex items-center gap-2 text-ios-subtext text-[17px] pl-2 shrink-0">
                {value}
                {onClick && <ChevronRight size={20} className="opacity-30" />}
             </div>
         )}
      </div>
    );

    const IOSInput = ({ value, onChange, placeholder, type="text", className="", ...props }) => (
      <input 
        type={type} 
        value={value} 
        onChange={onChange} 
        placeholder={placeholder} 
        className={`bg-transparent text-[17px] text-black placeholder-gray-400 outline-none ${className}`} 
        {...props}
      />
    );

    // --- MODULES DE L'APP ---

    const PackagingManager = ({ title, items, setItems }) => {
      const [isAdding, setIsAdding] = useState(false);
      const [newItem, setNewItem] = useState({ name: '', price: '' });
      
      const handleSave = () => {
         if (newItem.name) {
            setItems([...items, { id: generateId(), name: newItem.name, price: parseFloat(newItem.price) || 0 }]);
            setNewItem({ name: '', price: '' }); setIsAdding(false);
         }
      };
      
      const sortedItems = [...items].sort((a,b) => a.name.localeCompare(b.name));

      return (
        <IOSListGroup title={title}>
           {sortedItems.map((item) => (
              <IOSListItem key={item.id} isLast={false}>
                 <div className="flex w-full items-center gap-3">
                    <span className="flex-1 truncate">{item.name}</span>
                    <div className="w-20 text-right font-bold text-ios-blue flex-shrink-0">
                       {formatCurrency(item.price)}
                    </div>
                    <button onClick={(e) => { e.stopPropagation(); setItems(items.filter(i => i.id !== item.id)); }}>
                       <Trash2 size={18} className="text-ios-red opacity-50"/>
                    </button>
                 </div>
              </IOSListItem>
           ))}
           {isAdding ? (
              <div className="p-3 bg-gray-50 flex gap-2 items-center border-t border-gray-100">
                 <input className="flex-1 bg-white p-2 rounded border" placeholder="Nom" value={newItem.name} onChange={e=>setNewItem({...newItem, name: e.target.value})}/>
                 <input className="w-20 bg-white p-2 rounded border" type="number" placeholder="€" value={newItem.price} onChange={e=>setNewItem({...newItem, price: e.target.value})}/>
                 <button onClick={handleSave} className="text-ios-blue font-bold px-2">OK</button>
              </div>
           ) : (
              <div onClick={() => setIsAdding(true)} className="p-3 text-ios-blue flex items-center gap-2 cursor-pointer active:bg-gray-50 border-t border-gray-100">
                 <Plus size={20}/> Ajouter
              </div>
           )}
        </IOSListGroup>
      );
    };

    // --- VUE DETAIL (Lecture seule) ---
    const RecipeDetailView = ({ recipe, ingredients, recipes, settings, containers, labels, decorations, foils, onEdit, onBack }) => {
       const metrics = useMemo(() => {
         const rawMetrics = calculateRecipeMetrics(recipe.id, recipes, ingredients, settings);
         
         const foil = foils.find(f=>f.id===recipe.foilId);
         const foilCost = (foil?.price||0)*recipe.yieldCount;
         const packUnit = (containers.find(c=>c.id===recipe.containerId)?.price||0) + (labels.find(l=>l.id===recipe.labelId)?.price||0) + (decorations.find(d=>d.id===recipe.decorationId)?.price||0);
         const packTotal = foilCost + (packUnit*(recipe.unitCount||0)) + (recipe.extraCost||0);
         
         const total = rawMetrics.materialCost + rawMetrics.laborCost + rawMetrics.wasteCost + packTotal;
         return { 
            total, 
            mat: rawMetrics.materialCost, 
            labor: rawMetrics.laborCost, 
            waste: rawMetrics.wasteCost,
            pack: packTotal, 
            weight: rawMetrics.totalWeight, 
            costPerKg: rawMetrics.costPerKg 
         };
      }, [recipe, recipes, ingredients, settings, containers, labels, decorations, foils]);

      const goodsCost = metrics.mat + metrics.waste + metrics.pack;
      const sellingPriceBatch = (goodsCost * (1 + settings.defaultMargin / 100)) + metrics.labor;
      const sellingPriceKg = metrics.weight > 0 ? sellingPriceBatch / (metrics.weight/1000) : 0;
      const sellingPriceUnit = recipe.yieldCount > 0 ? sellingPriceBatch / recipe.yieldCount : 0;
      
      // Gestion de l'affichage de l'image (URL prioritaire)
      const displayImage = recipe.photoUrl || recipe.photo;
      
      // Gestion des allergènes (Array ou String)
      const allergensList = Array.isArray(recipe.allergens) 
          ? recipe.allergens 
          : (recipe.allergens ? recipe.allergens.split(',').map(s=>s.trim()).filter(s=>s) : []);

      return (
         <div className="bg-ios-bg fixed inset-0 z-40 overflow-auto animate-fade-in pb-safe pb-40">
            {/* HERO IMAGE HEADER */}
            <div className="relative w-full h-[300px] bg-gray-200">
                {displayImage ? (
                    <img src={displayImage} className="w-full h-full object-cover" alt={recipe.name} />
                ) : (
                    <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-amber-800 to-amber-950">
                        <ChefHat size={64} className="text-white/20" />
                    </div>
                )}
                {/* Overlay gradient pour le texte */}
                <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
                
                {/* Boutons Header Transparents */}
                <div className="absolute top-0 left-0 right-0 z-50 pt-safe px-4 py-2 flex justify-between items-center">
                    <button onClick={onBack} className="w-10 h-10 bg-black/30 backdrop-blur rounded-full flex items-center justify-center text-white active:bg-black/50 transition-colors">
                        <ChevronLeft size={24}/>
                    </button>
                    <button onClick={onEdit} className="w-10 h-10 bg-black/30 backdrop-blur rounded-full flex items-center justify-center text-white active:bg-black/50 transition-colors">
                        <Settings size={20} />
                    </button>
                </div>

                {/* Titre sur l'image */}
                <div className="absolute bottom-6 left-4 right-4">
                    <div className="text-white/80 text-sm font-semibold uppercase tracking-wider mb-1">{recipe.category}</div>
                    <h1 className="text-white text-3xl font-bold leading-tight shadow-sm">{recipe.name}</h1>
                </div>
            </div>
            
            <div className="p-4 space-y-6 -mt-2 relative z-10">
               <div className="flex items-center justify-between px-4 text-gray-500 text-sm bg-white rounded-xl py-3 shadow-sm mx-2">
                   <div className="text-center flex-1 border-r border-gray-100">
                      <div className="text-black font-bold text-lg">{recipe.prepTimeMinutes}</div>
                      <div className="text-[10px] uppercase">Minutes</div>
                   </div>
                   <div className="text-center flex-1">
                      <div className="text-black font-bold text-lg">{recipe.yieldCount}</div>
                      <div className="text-[10px] uppercase">Pièces</div>
                   </div>
               </div>

               {/* ALLERGENES TAGS (Amélioré) */}
               {allergensList.length > 0 && (
                   <div className="mx-2 bg-white rounded-xl p-4 shadow-sm">
                       <div className="flex items-center gap-2 mb-3">
                           <AlertTriangle className="text-orange-500" size={18} />
                           <span className="text-xs font-bold uppercase text-gray-500">Allergènes</span>
                       </div>
                       <div className="flex flex-wrap gap-2">
                           {allergensList.map(allergen => (
                               <span key={allergen} className="px-3 py-1 bg-orange-50 text-orange-700 text-sm font-medium rounded-full border border-orange-100">
                                   {allergen}
                               </span>
                           ))}
                       </div>
                   </div>
               )}

               <div>
                 <div className="px-4 text-[13px] uppercase text-ios-subtext font-semibold mb-2">Ingrédients</div>
                 <IOSListGroup>
                    {recipe.ingredients.length === 0 && <div className="p-4 text-center text-gray-400 italic">Vide</div>}
                    {recipe.ingredients.map((item, idx) => {
                      const isRec = !!item.recipeId;
                      const ref = isRec ? recipes.find(r=>r.id===item.recipeId) : ingredients.find(i=>i.id===item.ingredientId);
                      
                      let lineCost = 0;
                      if(isRec) {
                          const subM = calculateRecipeMetrics(item.recipeId, recipes, ingredients, settings);
                          const costPerG = subM.totalWeight > 0 ? subM.totalCost / subM.totalWeight : 0;
                          lineCost = item.quantity * costPerG;
                      } else if(ref) {
                          if(ref.unit === 'pce') lineCost = item.quantity * ref.price;
                          else lineCost = (item.quantity / 1000) * ref.price;
                      }

                      return (
                         <div key={idx} className="flex items-center justify-between px-4 py-3 border-b border-gray-100 last:border-0">
                            <div>
                               <div className="font-medium text-[17px]">{ref?.name || '???'}</div>
                               {isRec && <span className="text-[10px] bg-yellow-100 text-yellow-800 px-1 rounded">Sous-recette</span>}
                            </div>
                            <div className="text-gray-500 font-medium text-right">
                               <div>{item.quantity} {!isRec && ref?.unit==='pce'?'pce':'g'}</div>
                               <div className="text-xs text-gray-400">({formatCurrency(lineCost)})</div>
                            </div>
                         </div>
                      )
                    })}
                 </IOSListGroup>
               </div>

               <div>
                  <div className="px-4 text-[13px] uppercase text-ios-subtext font-semibold mb-2">Préparation</div>
                  <div className="mx-4 bg-white rounded-xl p-4 text-[17px] text-black leading-relaxed whitespace-pre-wrap shadow-sm">
                     {recipe.instructions ? recipe.instructions : <span className="text-gray-400 italic">Aucune étape renseignée.</span>}
                  </div>
               </div>

               <div className="mx-4 bg-[#3e2723] rounded-2xl p-6 text-white shadow-xl">
                 <div className="text-center mb-4 text-white/50 text-xs uppercase font-bold">Analyse Financière</div>
                 
                 <div className="flex justify-between items-center mb-2 border-b border-white/10 pb-4">
                    <div>
                        <div className="text-2xl font-bold text-white">{formatCurrency(sellingPriceKg)}</div>
                        <div className="text-xs text-white/70">Prix Vente / kg</div>
                    </div>
                    <div className="text-right">
                        <div className="text-2xl font-bold text-white">{formatCurrency(sellingPriceUnit)}</div>
                        <div className="text-xs text-white/70">Prix Vente / pièce</div>
                    </div>
                 </div>

                 <div className="text-center mb-6 pb-2 border-b border-white/10">
                    <div className="text-white/70 text-[10px] uppercase tracking-wide mb-1">Prix Vente Total : ((Matière + Emballage + Perte) x Marge) + Main d'œuvre</div>
                    <div className="text-xl font-bold text-white">{formatCurrency(sellingPriceBatch)}</div>
                 </div>

                 <div className="grid grid-cols-2 gap-y-4 gap-x-4 text-sm">
                     <div><div className="text-white/50 text-xs">Matière</div><div>{formatCurrency(metrics.mat)}</div></div>
                     <div><div className="text-white/50 text-xs">Main d'œuvre</div><div>{formatCurrency(metrics.labor)}</div></div>
                     <div><div className="text-white/50 text-xs">Emballage</div><div>{formatCurrency(metrics.pack)}</div></div>
                     <div><div className="text-white/50 text-xs">Perte ({settings.wastePercentage}%)</div><div>{formatCurrency(metrics.waste)}</div></div>
                     
                     <div className="col-span-2 border-t border-white/10 my-1"></div>
                     
                     <div><div className="text-white/50 text-xs">Coût Production (Total)</div><div>{formatCurrency(metrics.total)}</div></div>
                     <div><div className="text-white/50 text-xs">Poids Total</div><div>{(metrics.weight/1000).toFixed(2)} kg</div></div>
                     
                     <div className="col-span-2 pt-2 border-t border-white/10 flex justify-between items-center mt-1">
                        <div className="text-white/70 text-xs">Coût Revient / kg</div>
                        <div className="font-bold">{formatCurrency(metrics.weight > 0 ? metrics.total / (metrics.weight/1000) : 0)}</div>
                     </div>
                 </div>
              </div>
            </div>
         </div>
      );
    }

    // --- VUE EDITION INGREDIENT ---
    const IngredientEditView = ({ ingredient, categories, onSave, onCancel }) => {
       const [form, setForm] = useState(ingredient);
       return (
         <div className="bg-ios-bg fixed inset-0 z-[60] overflow-auto animate-slide-up pb-safe">
            <div className="sticky top-0 bg-white/90 backdrop-blur-md border-b z-50 px-4 py-3 flex justify-between items-center pt-safe">
              <button onClick={onCancel} className="text-ios-blue text-[17px]">Annuler</button>
              <span className="font-semibold text-[17px]">{form.id === 'new' ? 'Nouvel ingrédient' : 'Édition'}</span>
              <button onClick={() => onSave({...form, price: parseFloat(form.price) || 0, weightPerUnit: parseFloat(form.weightPerUnit) || 0})} className="text-ios-blue font-bold text-[17px]">OK</button>
            </div>
            
            <div className="p-4 space-y-6 mt-4">
               <IOSListGroup>
                  <div className="px-4 py-3 border-b border-gray-100">
                     <IOSInput placeholder="Nom de l'ingrédient" value={form.name} onChange={e=>setForm({...form, name: e.target.value})} className="font-bold text-lg w-full"/>
                  </div>
                  <div className="px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                     <span>Prix</span>
                     <div className="flex items-center gap-2">
                        <IOSInput type="number" className="text-right w-24" placeholder="Ex: 10" value={form.price} onChange={e=>setForm({...form, price: e.target.value})} />
                        <span className="text-gray-500">€</span>
                     </div>
                  </div>
                  <div className="px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                     <span>Unité</span>
                     <select className="bg-transparent text-ios-blue outline-none text-right" value={form.unit} onChange={e=>setForm({...form, unit: e.target.value})}>
                        <option value="kg">Kilogramme (kg)</option>
                        <option value="l">Litre (l)</option>
                        <option value="pce">Pièce (pce)</option>
                     </select>
                  </div>
                  {form.unit === 'pce' && (
                      <div className="px-4 py-3 border-b border-gray-100 flex justify-between items-center animate-fade-in">
                         <span className="text-black">Poids unitaire (g)</span>
                         <div className="flex items-center gap-2">
                            <IOSInput type="number" className="text-right w-24 text-black" placeholder="Ex: 5" value={form.weightPerUnit || ''} onChange={e=>setForm({...form, weightPerUnit: e.target.value})} />
                            <span className="text-gray-500">g</span>
                         </div>
                      </div>
                  )}
                  <div className="px-4 py-3 flex justify-between items-center">
                     <span>Catégorie</span>
                     <select className="bg-transparent text-ios-blue outline-none text-right" value={form.category} onChange={e=>setForm({...form, category: e.target.value})}>
                        {[...categories].sort((a,b) => a.localeCompare(b)).map(c=><option key={c} value={c}>{c}</option>)}
                        <option value="Autre">Autre</option>
                     </select>
                  </div>
               </IOSListGroup>
            </div>
         </div>
       );
    };

    // --- VUE EDITION RECETTE (Modal) ---
    const RecipeEditView = ({ recipe, ingredients, recipes, categories, containers, labels, decorations, foils, settings, onSave, onCancel, onDelete, onDuplicate }) => {
      // Conversion allergènes string -> array pour le formulaire
      const initialAllergens = Array.isArray(recipe.allergens) 
          ? recipe.allergens 
          : (recipe.allergens ? recipe.allergens.split(',').map(s=>s.trim()).filter(s=>s) : []);

      const [form, setForm] = useState({...recipe, allergens: initialAllergens});
      const [addMode, setAddMode] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [customAllergen, setCustomAllergen] = useState('');
      const fileInputRef = useRef(null);

      const isSubRecipe = form.category === 'Sous-recette';
      const toggleSubRecipe = () => {
         setForm(prev => ({ ...prev, category: prev.category === 'Sous-recette' ? 'Confiserie' : 'Sous-recette' }));
      };

      const handlePhotoUpload = async (e) => {
         const file = e.target.files[0];
         if (!file) return;
         try {
             const resizedDataUrl = await resizeImage(file, 800);
             setForm(prev => ({ ...prev, photo: resizedDataUrl }));
         } catch (error) {
             alert("Erreur lors du traitement de l'image");
             console.error(error);
         }
      };

      const toggleAllergen = (allergen) => {
          const current = form.allergens || [];
          if (current.includes(allergen)) {
              setForm({...form, allergens: current.filter(a => a !== allergen)});
          } else {
              setForm({...form, allergens: [...current, allergen]});
          }
      };

      const addCustomAllergen = () => {
          if(customAllergen && !form.allergens.includes(customAllergen)) {
              setForm({...form, allergens: [...form.allergens, customAllergen]});
              setCustomAllergen('');
          }
      };

      const metrics = useMemo(() => {
         const tempAllRecipes = recipes.map(r => r.id === form.id ? form : r);
         if (form.id === 'new') tempAllRecipes.push(form);

         const rawMetrics = calculateRecipeMetrics(form.id === 'new' ? form.id : form.id, tempAllRecipes.length > 0 ? tempAllRecipes : [form], ingredients, settings);
         
         const foil = foils.find(f=>f.id===form.foilId);
         const foilCost = (foil?.price||0)*form.yieldCount;
         const packUnit = (containers.find(c=>c.id===form.containerId)?.price||0) + (labels.find(l=>l.id===form.labelId)?.price||0) + (decorations.find(d=>d.id===form.decorationId)?.price||0);
         const packTotal = foilCost + (packUnit*(form.unitCount||0)) + (form.extraCost||0);
         const total = rawMetrics.materialCost + rawMetrics.laborCost + rawMetrics.wasteCost + packTotal;
         
         return { total, mat: rawMetrics.materialCost, labor: rawMetrics.laborCost, waste: rawMetrics.wasteCost, pack: packTotal, costPerKg: rawMetrics.costPerKg, weight: rawMetrics.totalWeight };
      }, [form, recipes, ingredients, settings, containers, labels, decorations, foils]);

      const goodsCost = metrics.mat + metrics.waste + metrics.pack;
      const sellingPriceBatch = (goodsCost * (1 + settings.defaultMargin / 100)) + metrics.labor;
      const sellingPriceKg = metrics.weight > 0 ? sellingPriceBatch / (metrics.weight/1000) : 0;
      const sellingPriceUnit = form.yieldCount > 0 ? sellingPriceBatch / form.yieldCount : 0;
      
      const displayImage = form.photoUrl || form.photo;

      return (
        <div className="bg-ios-bg fixed inset-0 z-[60] overflow-auto animate-slide-up pb-safe pb-40">
           <div className="sticky top-0 bg-white/90 backdrop-blur-md border-b z-50 px-4 py-3 flex justify-between items-center pt-safe">
              <button onClick={onCancel} className="text-ios-blue text-[17px]">Annuler</button>
              <span className="font-semibold text-[17px]">{form.id==='new'?'Nouvelle':'Édition'}</span>
              <button onClick={() => onSave(form)} className="text-ios-blue font-bold text-[17px]">OK</button>
           </div>
           
           <div className="p-4 space-y-6">
              {/* PHOTO UPLOAD + LIEN */}
              <div className="flex flex-col items-center justify-center">
                  <div 
                    className="w-32 h-32 rounded-2xl bg-gray-200 overflow-hidden relative shadow-md cursor-pointer group mb-4"
                    onClick={() => fileInputRef.current?.click()}
                  >
                      {displayImage ? (
                          <img src={displayImage} className="w-full h-full object-cover" alt="Recette" />
                      ) : (
                          <div className="flex flex-col items-center justify-center h-full text-gray-400">
                              <Camera size={32} />
                              <span className="text-[10px] mt-1">Ajouter</span>
                          </div>
                      )}
                      <div className="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                         <span className="text-white text-xs font-bold">Modifier</span>
                      </div>
                  </div>
                  
                  <div className="w-full">
                       <IOSListGroup>
                            <div className="px-4 py-3 flex items-center gap-3">
                                <LinkIcon size={20} className="text-gray-400" />
                                <IOSInput 
                                    placeholder="Lien Image (https://...)" 
                                    value={form.photoUrl || ''} 
                                    onChange={e=>setForm({...form, photoUrl: e.target.value})} 
                                    className="w-full text-sm"
                                />
                            </div>
                            <div className="px-4 py-3 border-t border-gray-100 flex justify-center">
                                <button onClick={() => fileInputRef.current?.click()} className="text-ios-blue text-sm font-medium">
                                    Ou choisir une photo locale
                                </button>
                            </div>
                       </IOSListGroup>
                  </div>
                  <input type="file" ref={fileInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" />
              </div>

              <IOSListGroup>
                 <div className="px-4 py-3 border-b border-gray-100"><IOSInput placeholder="Nom de la recette" value={form.name} onChange={e=>setForm({...form, name: e.target.value})} className="font-bold text-xl w-full"/></div>
                 
                 <div className="px-4 py-3 border-b border-gray-100 flex justify-between items-center cursor-pointer" onClick={toggleSubRecipe}>
                    <span className="text-[17px]">Est une sous-recette</span>
                    <div className={`w-[51px] h-[31px] rounded-full p-[2px] transition-colors duration-200 ${isSubRecipe ? 'bg-[#34c759]' : 'bg-[#e9e9ea]'}`}>
                        <div className={`bg-white w-[27px] h-[27px] rounded-full shadow-[0_2px_4px_rgba(0,0,0,0.2)] transform transition-transform duration-200 ${isSubRecipe ? 'translate-x-[20px]' : 'translate-x-0'}`}/>
                    </div>
                 </div>

                 {!isSubRecipe && (
                    <div className="px-4 py-3 border-b border-gray-100 flex justify-between">
                        <span>Catégorie</span>
                        <select className="bg-transparent text-ios-blue outline-none" value={form.category} onChange={e=>setForm({...form, category: e.target.value})}>
                        {[...categories].filter(c => c !== 'Sous-recette').sort((a,b) => a.localeCompare(b)).map(c=><option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                 )}

                 <div className="px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                    <span>Temps (min)</span>
                    <IOSInput type="number" className="text-right w-20" value={form.prepTimeMinutes||''} onChange={e=>setForm({...form, prepTimeMinutes: parseFloat(e.target.value)})} />
                 </div>
                 <div className="px-4 py-3 flex justify-between items-center">
                    <span>Rendement (pcs)</span>
                    <IOSInput type="number" className="text-right w-20" value={form.yieldCount||''} onChange={e=>setForm({...form, yieldCount: parseFloat(e.target.value)})} />
                 </div>
              </IOSListGroup>
              
              <div className="text-[13px] uppercase text-ios-subtext font-semibold px-4 mb-2">Allergènes</div>
              <div className="mx-4 bg-white rounded-xl p-4 shadow-sm mb-6">
                  <div className="flex flex-wrap gap-2 mb-3">
                      {PREDEFINED_ALLERGENS.map(allergen => {
                          const isSelected = form.allergens.includes(allergen);
                          return (
                              <button 
                                key={allergen}
                                onClick={() => toggleAllergen(allergen)}
                                className={`px-3 py-1.5 rounded-full text-sm font-medium border transition-all ${isSelected ? 'bg-ios-blue text-white border-ios-blue' : 'bg-gray-50 text-gray-600 border-gray-200 active:bg-gray-100'}`}
                              >
                                  {allergen}
                              </button>
                          );
                      })}
                      {form.allergens.filter(a => !PREDEFINED_ALLERGENS.includes(a)).map(custom => (
                          <button 
                            key={custom}
                            onClick={() => toggleAllergen(custom)}
                            className="px-3 py-1.5 rounded-full text-sm font-medium border bg-ios-blue text-white border-ios-blue"
                          >
                              {custom} <span className="opacity-50 ml-1">×</span>
                          </button>
                      ))}
                  </div>
                  <div className="flex gap-2 items-center pt-2 border-t border-gray-100">
                      <input 
                        className="flex-1 bg-gray-50 rounded px-2 py-1.5 text-sm outline-none border border-transparent focus:border-ios-blue focus:bg-white transition-colors"
                        placeholder="Autre allergène..."
                        value={customAllergen}
                        onChange={e => setCustomAllergen(e.target.value)}
                      />
                      <button onClick={addCustomAllergen} className="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-600 active:bg-ios-blue active:text-white transition-colors">
                          <Plus size={16} />
                      </button>
                  </div>
              </div>

              <div className="flex items-center justify-between px-4">
                 <div className="text-[13px] uppercase text-ios-subtext font-semibold">Composition</div>
                 <div className="flex gap-2">
                    <button onClick={()=>{setAddMode('ing');setSearchQuery('');}} className="text-ios-blue text-sm font-bold bg-blue-100 px-3 py-1 rounded-full">+ Ingr.</button>
                    <button onClick={()=>{setAddMode('rec');setSearchQuery('');}} className="text-ios-gold text-sm font-bold bg-yellow-100 px-3 py-1 rounded-full text-yellow-700">+ Recette</button>
                 </div>
              </div>

              <IOSListGroup>
                 {form.ingredients.length === 0 && <div className="p-4 text-center text-gray-400 italic">Aucun ingrédient</div>}
                 {form.ingredients.map((item, idx) => {
                    const isRec = !!item.recipeId;
                    const ref = isRec ? recipes.find(r=>r.id===item.recipeId) : ingredients.find(i=>i.id===item.ingredientId);
                    return (
                       <div key={idx} className="flex items-center justify-between px-4 py-3 border-b border-gray-100">
                          <div>
                             <div className="font-medium text-sm">{ref?.name || '???'}</div>
                             {isRec && <span className="text-[10px] bg-yellow-100 text-yellow-800 px-1 rounded">Sous-recette</span>}
                          </div>
                          <div className="flex items-center gap-2">
                             <IOSInput type="number" className="text-right w-16 bg-gray-100 rounded px-1" value={item.quantity||''} onChange={e=>{const n=[...form.ingredients];n[idx].quantity=parseFloat(e.target.value);setForm({...form,ingredients:n})}} />
                             <span className="text-xs text-gray-500 w-6">{!isRec && ref?.unit==='pce'?'pce':'g'}</span>
                             <button onClick={()=>setForm({...form, ingredients: form.ingredients.filter((_,i)=>i!==idx)})}><Trash2 size={16} className="text-red-300"/></button>
                          </div>
                       </div>
                    )
                 })}
              </IOSListGroup>

              {addMode && (
                 <div className="fixed inset-0 z-[60] bg-ios-bg flex flex-col animate-slide-up">
                    <div className="bg-white/90 backdrop-blur border-b pt-safe px-4 py-3 flex justify-between items-center shrink-0 z-20">
                       <h3 className="font-bold text-lg">Ajouter {addMode==='ing'?'Ingrédient':'Recette'}</h3>
                       <button onClick={()=>setAddMode(null)} className="text-ios-blue font-bold text-[17px]">Fermer</button>
                    </div>
                    <div className="px-4 py-3 bg-white border-b shrink-0 z-10">
                       <div className="bg-gray-100 rounded-xl px-3 py-2 flex items-center gap-2">
                          <Search size={18} className="text-gray-500" />
                          <input 
                            className="bg-transparent outline-none w-full text-[17px]" 
                            placeholder="Rechercher..." 
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                          />
                       </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 pb-safe bg-ios-bg">
                       <div className="space-y-2">
                          {(addMode==='ing' 
                            ? [...ingredients] 
                            : [...recipes].filter(r=>r.id!==form.id)
                           )
                           .filter(x => x.name.toLowerCase().includes(searchQuery.toLowerCase()))
                           .sort((a,b)=>a.name.localeCompare(b.name))
                           .map(x => (
                             <div key={x.id} onClick={()=>{setForm({...form, ingredients: [...form.ingredients, addMode==='ing'?{ingredientId:x.id,quantity:0}:{recipeId:x.id,quantity:0}]});setAddMode(null)}} className="p-4 bg-white rounded-xl shadow-sm font-medium active:bg-blue-50 cursor-pointer border border-gray-100">
                                {x.name}
                             </div>
                          ))}
                          {(addMode==='ing' ? ingredients : recipes.filter(r=>r.id!==form.id)).filter(x => x.name.toLowerCase().includes(searchQuery.toLowerCase())).length === 0 && (
                              <div className="text-center text-gray-400 py-10 italic">Aucun résultat</div>
                           )}
                       </div>
                    </div>
                 </div>
              )}

              <IOSListGroup title="Préparation / Étapes">
                 <textarea 
                    className="w-full h-40 p-4 bg-white text-[17px] outline-none resize-none leading-relaxed"
                    placeholder="Écrivez les étapes de la recette ici..."
                    value={form.instructions || ''}
                    onChange={e => setForm({...form, instructions: e.target.value})}
                 />
              </IOSListGroup>

              <IOSListGroup title="Conditionnement">
                 <div className="px-4 py-3 border-b border-gray-100 flex justify-between">
                    <span className="text-sm">Papillote</span>
                    <select className="bg-transparent text-ios-blue outline-none w-32 text-right text-sm" value={form.foilId||''} onChange={e=>setForm({...form, foilId: e.target.value})}><option value="">Aucune</option>{foils.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}</select>
                 </div>
                 <div className="px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                    <span className="text-sm">Nb Boîtes</span>
                    <IOSInput type="number" placeholder="ex: 10" className="text-right w-24" value={form.unitCount||''} onChange={e=>setForm({...form, unitCount: parseFloat(e.target.value)})} />
                 </div>
                 {['containerId','labelId','decorationId'].map(field => {
                     const list = field.startsWith('c')?containers:(field.startsWith('l')?labels:decorations);
                     const lab = field.startsWith('c')?'Contenant':(field.startsWith('l')?'Étiquette':'Déco');
                     return (
                        <div key={field} className="px-4 py-3 border-b border-gray-100 flex justify-between">
                           <span className="text-sm text-gray-600">{lab}</span>
                           <select className="bg-transparent text-ios-blue outline-none w-32 text-right text-sm" value={form[field]||''} onChange={e=>setForm({...form, [field]: e.target.value})}><option value="">-</option>{list.map(x=><option key={x.id} value={x.id}>{x.name}</option>)}</select>
                        </div>
                     )
                 })}
                 <div className="px-4 py-3 flex justify-between items-center">
                    <span className="text-sm">Extra (€)</span>
                    <IOSInput type="number" placeholder="ex: 0.50" className="text-right w-24" value={form.extraCost||''} onChange={e=>setForm({...form, extraCost: parseFloat(e.target.value)})} />
                 </div>
              </IOSListGroup>

              <div className="mx-4 bg-[#3e2723] rounded-2xl p-6 text-white shadow-xl mb-6">
                 <div className="text-center mb-4 text-white/50 text-xs uppercase font-bold">Analyse Financière</div>
                 
                 <div className="flex justify-between items-center mb-2 border-b border-white/10 pb-4">
                    <div>
                        <div className="text-2xl font-bold text-white">{formatCurrency(sellingPriceKg)}</div>
                        <div className="text-xs text-white/70">Prix Vente / kg</div>
                    </div>
                    <div className="text-right">
                        <div className="text-2xl font-bold text-white">{formatCurrency(sellingPriceUnit)}</div>
                        <div className="text-xs text-white/70">Prix Vente / pièce</div>
                    </div>
                 </div>

                 <div className="text-center mb-6 pb-2 border-b border-white/10">
                    <div className="text-white/70 text-[10px] uppercase tracking-wide mb-1">Prix Vente Total : ((Matière + Emballage + Perte) x Marge) + Main d'œuvre</div>
                    <div className="text-xl font-bold text-white">{formatCurrency(sellingPriceBatch)}</div>
                 </div>

                 <div className="grid grid-cols-2 gap-y-4 gap-x-4 text-sm">
                     <div><div className="text-white/50 text-xs">Matière</div><div>{formatCurrency(metrics.mat)}</div></div>
                     <div><div className="text-white/50 text-xs">Main d'œuvre</div><div>{formatCurrency(metrics.labor)}</div></div>
                     <div><div className="text-white/50 text-xs">Emballage</div><div>{formatCurrency(metrics.pack)}</div></div>
                     <div><div className="text-white/50 text-xs">Perte ({settings.wastePercentage}%)</div><div>{formatCurrency(metrics.waste)}</div></div>
                     
                     <div className="col-span-2 border-t border-white/10 my-1"></div>
                     
                     <div><div className="text-white/50 text-xs">Coût Production (Total)</div><div>{formatCurrency(metrics.total)}</div></div>
                     <div><div className="text-white/50 text-xs">Poids Total</div><div>{(metrics.weight/1000).toFixed(2)} kg</div></div>
                     
                     <div className="col-span-2 pt-2 border-t border-white/10 flex justify-between items-center mt-1">
                        <div className="text-white/70 text-xs">Coût Revient / kg</div>
                        <div className="font-bold">{formatCurrency(metrics.weight > 0 ? metrics.total / (metrics.weight/1000) : 0)}</div>
                     </div>
                 </div>
              </div>

              {onDelete && form.id!=='new' && (
                 <div className="mb-12">
                     <button 
                        type="button" 
                        onClick={(e) => { e.stopPropagation(); onDuplicate(); }}
                        className="w-full mx-4 mb-3 bg-white text-ios-blue border border-ios-blue font-bold py-3 rounded-xl text-center shadow-sm cursor-pointer active:scale-[0.98] transition-transform block"
                     >
                        Dupliquer la recette
                     </button>

                     <button 
                        type="button" 
                        onClick={(e) => { e.stopPropagation(); onDelete(); }}
                        className="w-full mx-4 bg-ios-red text-white font-bold py-3 rounded-xl text-center shadow cursor-pointer active:scale-[0.98] transition-transform block"
                     >
                        Supprimer la recette
                     </button>
                 </div>
              )}
           </div>
        </div>
      );
    };

    // 3. Application Principale
    const App = () => {
      const [view, setView] = useState('dashboard');
      const [ingredients, setIngredients] = useState([{id:'1',name:'Chocolat Noir',price:12.50,unit:'kg',category:'Chocolat'}]);
      const [recipes, setRecipes] = useState([]);
      const [settings, setSettings] = useState(DEFAULT_SETTINGS);
      const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
      const [containers, setContainers] = useState([]);
      const [labels, setLabels] = useState([]);
      const [decorations, setDecorations] = useState([]);
      const [foils, setFoils] = useState([]);
      
      const [viewingId, setViewingId] = useState(null); 
      const [editingId, setEditingId] = useState(null); 
      const [editingIngredient, setEditingIngredient] = useState(null); 
      const [recipeTab, setRecipeTab] = useState('main'); 
      const [filterCategory, setFilterCategory] = useState(null);
      const [showFilterMenu, setShowFilterMenu] = useState(false);
      const [dashboardSearch, setDashboardSearch] = useState('');
      const [alertConfig, setAlertConfig] = useState({ isOpen: false, title: '', message: '', onConfirm: null });

      const requestConfirm = (title, message, action) => {
         setAlertConfig({
            isOpen: true, 
            title, 
            message, 
            onConfirm: () => { action(); setAlertConfig(prev => ({...prev, isOpen: false})); }
         });
      };

      useEffect(() => {
         const d = localStorage.getItem('choco_app_ios_v2');
         if(d) {
            try {
                const p = JSON.parse(d);
                if(p.ingredients) setIngredients(p.ingredients);
                if(p.recipes) setRecipes(p.recipes);
                if(p.settings) setSettings(p.settings);
                if(p.categories) setCategories(p.categories);
                if(p.containers) setContainers(p.containers);
                if(p.labels) setLabels(p.labels);
                if(p.decorations) setDecorations(p.decorations);
                if(p.foils) setFoils(p.foils);
            } catch(e) { console.error(e); }
         }
      }, []);

      useEffect(() => {
         const data = { ingredients, recipes, settings, categories, containers, labels, decorations, foils };
         localStorage.setItem('choco_app_ios_v2', JSON.stringify(data));
      }, [ingredients, recipes, settings, categories, containers, labels, decorations, foils]);

      const handleImport = (e) => {
          const file = e.target.files && e.target.files[0];
          if(!file) return;
          const r = new FileReader();
          r.onload = (ev) => {
             try {
                const p = JSON.parse(ev.target.result);
                if(p.ingredients) setIngredients(p.ingredients);
                if(p.recipes) setRecipes(p.recipes);
                if(p.settings) setSettings(p.settings);
                if(p.categories) setCategories(p.categories);
                if(p.containers) setContainers(p.containers);
                if(p.labels) setLabels(p.labels);
                if(p.decorations) setDecorations(p.decorations);
                if(p.foils) setFoils(p.foils);
                alert("Importation réussie !");
             } catch(err) { alert("Erreur fichier invalide"); }
          }
          r.readAsText(file);
          e.target.value = '';
      };

      const handleExport = () => {
          const data = localStorage.getItem('choco_app_ios_v2');
          const blob = new Blob([data], {type: 'application/json'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `backup_choco_${new Date().toISOString().slice(0,10)}.json`;
          a.click();
      }

      // --- GROUPE LES RECETTES PAR CATEGORIE POUR LE DASHBOARD ---
      const groupedRecipes = useMemo(() => {
          const groups = {};
          recipes.forEach(r => {
              if (r.category === 'Sous-recette') return; // On masque les sous-recettes de l'accueil pour l'instant
              if (!groups[r.category]) groups[r.category] = [];
              groups[r.category].push(r);
          });
          return groups;
      }, [recipes]);

      const renderContent = () => {
         if (view === 'dashboard') {
            return (
               <div className="pb-32">
                  <IOSHeader 
                    title="Accueil" 
                    subtitle={settings.chefName} 
                    transparent={false} 
                    rightAction={
                        <button onClick={() => { setView('recipes'); setEditingId('new'); }} className="bg-ios-blue text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md active:scale-95 transition-transform">
                             <Plus size={20} />
                        </button>
                    }
                  />
                  
                  <div className="px-4 mt-2 mb-6">
                     <div className="bg-gray-200/50 rounded-xl px-3 py-2.5 flex items-center gap-2">
                        <Search size={18} className="text-gray-500" />
                        <input 
                           className="bg-transparent outline-none w-full text-[17px] placeholder-gray-500" 
                           placeholder="Rechercher une recette..." 
                           value={dashboardSearch}
                           onChange={(e) => setDashboardSearch(e.target.value)}
                        />
                        {dashboardSearch && (
                           <button onClick={()=>setDashboardSearch('')}><X size={18} className="text-gray-500"/></button>
                        )}
                     </div>
                  </div>

                  {dashboardSearch.length > 0 ? (
                     <div className="mt-4">
                        <IOSListGroup title="Résultats">
                           {recipes
                              .filter(r => r.name.toLowerCase().includes(dashboardSearch.toLowerCase()))
                              .sort((a,b) => a.name.localeCompare(b.name))
                              .map((r, i) => (
                              <IOSListItem 
                                 key={r.id} 
                                 label={r.name} 
                                 value={r.category}
                                 isLast={false} 
                                 onClick={() => {
                                    setViewingId(r.id);
                                    setDashboardSearch('');
                                 }}
                              />
                           ))}
                        </IOSListGroup>
                     </div>
                  ) : (
                     <div className="animate-fade-in space-y-8 mt-4">
                        {/* LISTE PAR CATEGORIES (STYLE PODCASTS) */}
                        {Object.keys(groupedRecipes).sort().map(cat => (
                            <div key={cat} className="flex flex-col">
                                <div className="px-4 flex items-center justify-between mb-3">
                                    <h2 className="text-xl font-bold text-black">{cat}</h2>
                                    <ChevronRight size={18} className="text-gray-400" />
                                </div>
                                <div className="flex overflow-x-auto px-4 gap-4 pb-4 no-scrollbar snap-x">
                                    {groupedRecipes[cat].map(recipe => (
                                        <div 
                                            key={recipe.id} 
                                            className="min-w-[160px] w-[160px] snap-start flex flex-col gap-2 cursor-pointer active:scale-95 transition-transform"
                                            onClick={() => setViewingId(recipe.id)}
                                        >
                                            <div className="aspect-square w-full rounded-xl bg-gray-100 shadow-md overflow-hidden relative">
                                                {(recipe.photoUrl || recipe.photo) ? (
                                                    <img src={recipe.photoUrl || recipe.photo} className="w-full h-full object-cover" alt={recipe.name} />
                                                ) : (
                                                    <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-gray-50 to-gray-200">
                                                        <ChefHat size={32} className="text-gray-300 mb-2" />
                                                    </div>
                                                )}
                                            </div>
                                            <div>
                                                <h3 className="text-[15px] font-semibold text-black leading-tight line-clamp-2">{recipe.name}</h3>
                                                <p className="text-[13px] text-gray-500 mt-0.5">{recipe.yieldCount} pcs</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="h-px bg-gray-200 mx-4 mt-2"></div>
                            </div>
                        ))}
                        
                        {Object.keys(groupedRecipes).length === 0 && (
                            <div className="text-center py-10 text-gray-400">
                                Aucune recette pour le moment.
                            </div>
                        )}
                     </div>
                  )}
               </div>
            )
         }
         // ... Le reste (recipes, ingredients, settings) reste le même
         if (view === 'recipes') {
             const filteredRecipes = recipes
                 .filter(r => recipeTab === 'sub' ? r.category === 'Sous-recette' : r.category !== 'Sous-recette')
                 .filter(r => filterCategory ? r.category === filterCategory : true)
                 .sort((a,b) => a.name.localeCompare(b.name));

             const leftAction = recipeTab === 'main' ? (
                <button onClick={() => setShowFilterMenu(true)} className={`flex items-center justify-center w-10 h-10 -ml-2 rounded-full active:bg-gray-100 ${filterCategory ? 'text-ios-blue' : 'text-ios-blue'}`}>
                   <Filter size={24} className={filterCategory ? "fill-current" : ""} strokeWidth={2} />
                </button>
             ) : null;

             return (
                 <div className="pb-32">
                    <IOSHeader title="Liste" leftAction={leftAction} rightAction={<button onClick={()=>setEditingId('new')} className="text-ios-blue"><Plus size={24}/></button>} />
                    <div className="px-4 pb-4">
                       <div className="bg-[#e3e3e8] p-0.5 rounded-lg flex h-8 relative">
                          <button onClick={()=>{setRecipeTab('main'); setFilterCategory(null);}} className={`flex-1 rounded-[7px] text-[13px] font-medium transition-all z-10 ${recipeTab==='main'?'bg-white shadow text-black':'text-gray-500'}`}>Recettes Principales</button>
                          <button onClick={()=>{setRecipeTab('sub'); setFilterCategory(null);}} className={`flex-1 rounded-[7px] text-[13px] font-medium transition-all z-10 ${recipeTab==='sub'?'bg-white shadow text-black':'text-gray-500'}`}>Sous-recettes</button>
                       </div>
                    </div>
                    {filterCategory && (
                       <div className="px-4 pb-3 flex items-center justify-between animate-fade-in">
                           <div className="text-sm font-semibold text-black">Filtre : <span className="text-ios-blue">{filterCategory}</span></div>
                           <button onClick={()=>setFilterCategory(null)} className="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full flex items-center gap-1"><X size={12}/> Effacer</button>
                       </div>
                    )}
                    {filteredRecipes.length === 0 ? <div className="p-10 text-center text-gray-400">Aucune recette trouvée</div> : (
                       <IOSListGroup>
                          {filteredRecipes.map(r => {
                                const met = calculateRecipeMetrics(r.id, recipes, ingredients, settings);
                                const foil = foils.find(f=>f.id===r.foilId);
                                const foilCost = (foil?.price||0)*r.yieldCount;
                                const packUnit = (containers.find(c=>c.id===r.containerId)?.price||0) + (labels.find(l=>l.id===r.labelId)?.price||0) + (decorations.find(d=>d.id===r.decorationId)?.price||0);
                                const packTotal = foilCost + (packUnit*(r.unitCount||0)) + (r.extraCost||0);
                                const fullTotalCost = met.totalCost + packTotal;
                                const goodsCost = met.materialCost + met.wasteCost + packTotal;
                                const sellBatch = (goodsCost * (1 + settings.defaultMargin / 100)) + met.laborCost;
                                const sellKg = met.totalWeight > 0 ? sellBatch / (met.totalWeight/1000) : 0;
                                const sellUnit = r.yieldCount > 0 ? sellBatch / r.yieldCount : 0;
                                const costPerKg = met.totalWeight > 0 ? fullTotalCost / (met.totalWeight/1000) : 0;

                                return (
                                   <SwipeRow key={r.id} onDelete={()=>{ requestConfirm("Supprimer la recette ?", `Êtes-vous sûr de vouloir supprimer "${r.name}" ?`, () => setRecipes(recipes.filter(x => x.id !== r.id))); }}>
                                      <div className="pl-4 pr-4 py-3 flex w-full items-center gap-2 active:bg-gray-100 transition-colors" onClick={()=>setViewingId(r.id)}>
                                         {/* MINIATURE DANS LISTE */}
                                         <div className="w-10 h-10 rounded bg-gray-200 shrink-0 overflow-hidden">
                                             {(r.photoUrl || r.photo) ? <img src={r.photoUrl || r.photo} className="w-full h-full object-cover"/> : <ChefHat className="w-full h-full p-2 text-gray-400"/>}
                                         </div>
                                         <div className="flex-1 min-w-0">
                                            <div className="font-semibold truncate text-[17px]">{r.name}</div>
                                            <div className="text-[14px] text-gray-500">{r.category}</div>
                                         </div>
                                         <div className="flex flex-col items-end min-w-[120px] border-l border-gray-100 pl-2 ml-2 text-right">
                                            <div className="text-ios-blue font-bold text-[14px]">Vente {formatCurrency(sellKg)} / kg</div>
                                            <div className="text-[11px] text-green-600 font-medium">Unit. {formatCurrency(sellUnit)}</div>
                                            <div className="text-[11px] text-gray-500 font-medium">Coût {formatCurrency(costPerKg)} / kg</div>
                                         </div>
                                         <ChevronRight size={20} className="text-ios-subtext opacity-30" />
                                      </div>
                                   </SwipeRow>
                                );
                             })}
                       </IOSListGroup>
                    )}
                    {showFilterMenu && (
                        <div className="fixed inset-0 z-50 flex items-end justify-center sm:items-center bg-black/40 backdrop-blur-sm animate-fade-in" onClick={() => setShowFilterMenu(false)}>
                            <div className="bg-white w-full sm:w-[320px] sm:rounded-2xl rounded-t-2xl overflow-hidden shadow-2xl animate-slide-up pb-safe" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/80 backdrop-blur">
                                    <span className="font-bold text-[17px]">Filtrer par catégorie</span>
                                    <button onClick={() => setShowFilterMenu(false)} className="bg-gray-200 rounded-full p-1 text-gray-500"><X size={16}/></button>
                                </div>
                                <div className="max-h-[60vh] overflow-y-auto">
                                     <div onClick={() => { setFilterCategory(null); setShowFilterMenu(false); }} className={`px-4 py-3.5 border-b border-gray-100 active:bg-gray-100 cursor-pointer flex justify-between items-center ${filterCategory === null ? 'text-ios-blue font-semibold bg-blue-50/50' : ''}`}>
                                        <span className="text-[17px]">Tout afficher</span>{filterCategory === null && <span className="text-ios-blue font-bold">✓</span>}
                                     </div>
                                     {[...categories].filter(c => c !== 'Sous-recette').sort().map(cat => (
                                         <div key={cat} onClick={() => { setFilterCategory(cat); setShowFilterMenu(false); }} className={`px-4 py-3.5 border-b border-gray-100 active:bg-gray-100 cursor-pointer flex justify-between items-center ${filterCategory === cat ? 'text-ios-blue font-semibold bg-blue-50/50' : ''}`}>
                                            <span className="text-[17px]">{cat}</span>{filterCategory === cat && <span className="text-ios-blue font-bold">✓</span>}
                                         </div>
                                     ))}
                                </div>
                            </div>
                        </div>
                    )}
                 </div>
             )
         }
         if (view === 'ingredients') {
             const sortedIngredients = [...ingredients].sort((a,b) => a.name.localeCompare(b.name));
             return (
                <div className="pb-32">
                   <IOSHeader title="Ingrédients" rightAction={<button onClick={()=>setEditingIngredient({id: 'new', name: '', price: '', unit: 'kg', category: 'Autre'})} className="text-ios-blue min-w-[44px] flex items-center justify-end"><Plus size={24}/></button>} />
                   <IOSListGroup>
                      {sortedIngredients.map((ing) => (
                         <SwipeRow key={ing.id} onDelete={()=>{requestConfirm("Supprimer l'ingrédient ?", `Voulez-vous supprimer "${ing.name}" ?`, () => setIngredients(ingredients.filter(x => x.id !== ing.id)));}}>
                             <IOSListItem label={ing.name} value={`${formatCurrency(ing.price)} / ${ing.unit}`} onClick={() => setEditingIngredient(ing)} isLast={false} />
                         </SwipeRow>
                      ))}
                   </IOSListGroup>
                </div>
             )
         }
         if (view === 'settings') {
             return (
                <div className="pb-32">
                   <IOSHeader title="Réglages" />
                   <IOSListGroup title="Général">
                      <div className="px-4 py-3 flex justify-between border-b border-gray-100"><span>Nom Chef</span><IOSInput className="text-right" value={settings.chefName} onChange={e=>setSettings({...settings,chefName:e.target.value})} /></div>
                      <div className="px-4 py-3 flex justify-between border-b border-gray-100"><span>Taux Horaire</span><IOSInput type="number" className="text-right" value={settings.hourlyRate} onChange={e=>setSettings({...settings,hourlyRate:parseFloat(e.target.value)})} /></div>
                      <div className="px-4 py-3 flex justify-between"><span>Marge %</span><IOSInput type="number" className="text-right" value={settings.defaultMargin} onChange={e=>setSettings({...settings,defaultMargin:parseFloat(e.target.value)})} /></div>
                   </IOSListGroup>
                   <PackagingManager title="Contenants" items={containers} setItems={setContainers} />
                   <PackagingManager title="Étiquettes" items={labels} setItems={setLabels} />
                   <PackagingManager title="Décorations" items={decorations} setItems={setDecorations} />
                   <PackagingManager title="Papillotes" items={foils} setItems={setFoils} />
                   <IOSListGroup title="Données">
                      <IOSListItem label="Exporter JSON" icon={Download} onClick={handleExport} />
                      <div className="relative"><IOSListItem label="Importer JSON" icon={Upload} isLast /><input type="file" onChange={handleImport} accept=".json" className="absolute inset-0 w-full h-full opacity-0 z-50 cursor-pointer" /></div>
                   </IOSListGroup>
                   <div className="text-center p-6 text-ios-subtext text-xs">ChocoCost {APP_VERSION}</div>
                </div>
             )
         }
      }

      const navItems = [
         { id: 'dashboard', icon: LayoutDashboard, label: 'Accueil' },
         { id: 'recipes', icon: ChefHat, label: 'Recettes' },
         { id: 'ingredients', icon: List, label: 'Ingréd.' },
         { id: 'settings', icon: Settings, label: 'Réglages' },
      ];

      return (
         <div className="h-full relative">
            <IOSAlert isOpen={alertConfig.isOpen} title={alertConfig.title} message={alertConfig.message} onConfirm={alertConfig.onConfirm} onCancel={() => setAlertConfig(prev => ({...prev, isOpen: false}))} />
            
            {/* VUES MODALES AU TOP NIVEAU */}
            {viewingId && !editingId && (
               <RecipeDetailView 
                  recipe={recipes.find(r=>r.id===viewingId)}
                  ingredients={ingredients} recipes={recipes} settings={settings}
                  containers={containers} labels={labels} decorations={decorations} foils={foils}
                  onBack={()=>setViewingId(null)}
                  onEdit={()=>setEditingId(viewingId)}
               />
            )}
            {editingId && (
               <RecipeEditView 
                  recipe={editingId==='new' ? {id:'new',name:'',category:'Confiserie',ingredients:[],prepTimeMinutes:0,yieldCount:1,extraCost:0,foilId:'',unitCount:0,containerId:'',labelId:'',decorationId:'', allergens: []} : recipes.find(r=>r.id===editingId)}
                  ingredients={ingredients} recipes={recipes} categories={categories} settings={settings}
                  containers={containers} labels={labels} decorations={decorations} foils={foils}
                  onCancel={()=>setEditingId(null)}
                  onSave={(r)=>{
                     if(r.id==='new') setRecipes([...recipes, {...r, id:generateId()}]);
                     else setRecipes(recipes.map(x=>x.id===r.id?r:x));
                     setEditingId(null);
                     if(r.id!=='new') setViewingId(r.id);
                  }}
                  onDelete={editingId!=='new' ? () => {requestConfirm("Supprimer la recette ?", "Cette action est irréversible.", () => {setRecipes(recipes.filter(r=>r.id!==editingId));setEditingId(null);setViewingId(null);});} : undefined}
                  onDuplicate={editingId!=='new' ? () => {
                     const original = recipes.find(r => r.id === editingId);
                     if (original) {
                        const newRecipe = {...original, id: generateId(), name: `${original.name} (Copie)`};
                        setRecipes([...recipes, newRecipe]);
                        setEditingId(null);
                        alert(`Recette dupliquée : ${newRecipe.name}`);
                     }
                  } : undefined}
               />
            )}
            {editingIngredient && (
               <IngredientEditView
                  ingredient={editingIngredient}
                  categories={categories}
                  onCancel={() => setEditingIngredient(null)}
                  onSave={(ing) => {
                     if (ing.id === 'new') setIngredients([...ingredients, { ...ing, id: generateId() }]);
                     else setIngredients(ingredients.map(x => x.id === ing.id ? ing : x));
                     setEditingIngredient(null);
                  }}
               />
            )}

            <main className="absolute inset-0 overflow-y-auto no-scrollbar bg-ios-bg pb-24">
               {renderContent()}
            </main>
            <nav className="fixed bottom-0 w-full bg-[#f9f9f9]/90 backdrop-blur-xl border-t border-gray-300/50 pb-safe pt-2 flex justify-around z-50">
               {navItems.map(item => (
                  <button key={item.id} onClick={()=>setView(item.id)} className={`flex flex-col items-center w-16 ${view===item.id?'text-ios-blue':'text-gray-400'}`}>
                     <item.icon size={26} strokeWidth={view===item.id?2.5:2} />
                     <span className="text-[10px] font-medium mt-1">{item.label}</span>
                  </button>
               ))}
            </nav>
         </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
